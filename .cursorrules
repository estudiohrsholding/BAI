# B.A.I. (Business Artificial Intelligence) - MASTER CONTEXT

**Role:** You are the Lead Full Stack Architect for B.A.I., a "Partner as a Service" (PaaS) platform.
**Philosophy:** "Radical Simplicity". We hide complex tech (n8n, scraping) behind a friendly AI interface.

---

## 1. ARCHITECTURE & INFRASTRUCTURE
- **Type:** Dockerized Monorepo orchestrated via `docker-compose.yml`.
- **Network:** Services communicate via the `bai` bridge network.
- **Services:**
  - **Frontend:** Next.js 14 (App Router) on Port `3000`.
  - **Backend:** FastAPI (Python 3.11) on Port `8000`.
  - **Database:** PostgreSQL 15 (Service: `db`, Port: `5432`).
  - **Automation:** n8n (Service: `n8n`, Port: `5678`). **Internal access only via Backend.**

## 2. TECH STACK & STANDARDS

### Frontend (The Body)
- **Framework:** Next.js 14.2+ (App Router).
- **Styling:** Tailwind CSS + Shadcn/ui.
- **Folder Structure (CRITICAL):**
  - `src/app/(marketing)`: Public Landing Page (`/`).
  - `src/app/(platform)`: Protected Dashboard (`/dashboard`, `/automation`, etc.).
  - `src/middleware.ts`: "Allow List" strategy. Protects specific paths.
- **Auth:** `js-cookie` stores the JWT. `Authorization: Bearer <token>` header required for API calls.
- **Key Components:**
  - `DashboardShell`: Wrapper for protected pages (Sidebar + Avatar).
  - `BaiAvatar`: Persists in `(platform)/layout.tsx`. Hides on auth pages.

### Backend (The Brain)
- **Framework:** FastAPI.
- **ORM:** SQLModel (SQLAlchemy + Pydantic).
- **AI Engine:** Google Gemini 2.5 Flash (via `google-generativeai >= 0.8.5`).
- **Security:** OAuth2 with Password Flow.
  - **Hashing:** `bcrypt==4.0.1` (Pinned to avoid `passlib` conflicts).
  - **Token:** JWT (HS256).
- **Tools:**
  - `httpx`: For calling n8n webhooks.
  - `Brave Search API`: For Data Mining.

## 3. THE TRINITY (Service Logic)

### Service 1: Automation (n8n)
- **Logic:** Python detects intent -> Calls `http://n8n:5678/webhook/test` -> n8n executes -> Returns JSON.
- **UI Rule (Opaque Wall):** The "Open Workflow Editor" button in `/automation` is visible **ONLY** to Admins (`admin@bai.com`). Clients see a "Request Service" button.

### Service 2: Software Studio
- **Logic:** A static gallery of developed apps (e.g., Cannabiapp).
- **UI:** Uses `Google Favicon Service` to fetch real logos dynamically.

### Service 3: Data Mining (Brave)
- **Logic:** `bai_brain.py` detects search intent -> Calls Brave API -> Injects results into Gemini context.
- **Logs:** Every search is saved to `SearchLog` table and displayed in `/data`.

## 4. DEVELOPMENT RULES
1.  **Docker Rebuilds:** If modifying `backend/requirements.txt` or `.env`, ALWAYS run:
    `docker compose down && docker compose up --build`
2.  **Syntax:** Be careful with bracket balancing in Next.js pages (`useEffect`, `const` arrays).
3.  **Environment:**
    - Frontend talks to Backend via `NEXT_PUBLIC_API_URL` (Client-side) or `http://backend:8000` (Server-side).
    - Backend talks to n8n via `http://n8n:5678`.

## 5. CURRENT STATE (Nov 2025)
- MVP is **Production Ready**.
- Auth System is live (Login/Register/Logout).
- Database schema includes `User`, `ChatMessage` (with user_id), and `SearchLog`.